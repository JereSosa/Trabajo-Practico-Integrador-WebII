extends ../layout

block contenido
    // Header con hamburguesa
    header.flex.items-center.justify-between.px-6.py-4.bg-gray-800.shadow-md.mb-8
        button#menu-btn.flex.items-center.text-3xl.text-white(type="button")
            i.fas.fa-bars
        h1.text-3xl.font-bold.text-white Gestión de Habitaciones
        span

    // Sidebar hamburguesa (desplegable)
    aside#sidebar.fixed.top-0.left-0.h-full.w-60.bg-blue-900.p-6.text-white.z-50.shadow-2xl.transform.-translate-x-full.transition-all
        button#close-sidebar.text-2xl.absolute.top-4.right-4(type="button") &times;
        h2.text-xl.font-bold.mb-8 Menú
        nav.flex.flex-col.gap-3
            button.sidebar-btn(data-filter="all" class="bg-blue-500 hover:bg-blue-700 transition rounded py-2 font-semibold shadow") Todas las camas
            button.sidebar-btn(data-filter="libres" class="bg-green-500 hover:bg-green-700 transition rounded py-2 font-semibold shadow") Camas libres
            button.sidebar-btn(data-filter="ocupadas" class="bg-pink-500 hover:bg-pink-600 transition rounded py-2 font-semibold shadow") Ocupadas
            button.sidebar-btn(data-filter="higienizando" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 transition rounded py-2 font-semibold shadow") Higienizando

    // Overlay para cerrar sidebar
    div#sidebar-overlay.fixed.inset-0.z-40.bg-black.bg-opacity-30.hidden

    // Main grid
    main.px-6
        div(class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10")
            each ala in alas
                section(class="bg-white rounded-2xl shadow-2xl p-6 flex flex-col gap-6")
                    h2(class="text-2xl font-extrabold mb-2 text-blue-900")= ala.nombre
                    each habitacion in ala.habitaciones
                        .habitacion(class="flex flex-col gap-2 bg-gradient-to-r from-gray-100 to-gray-300 rounded-xl p-4 shadow")
                            .flex.items-center.mb-1
                                h3(class="text-lg font-bold text-gray-800 flex-1")= habitacion.nombre
                                button.add-cama-btn(
                                    class="bg-blue-300 text-blue-900 text-sm font-bold px-2 py-1 rounded shadow hover:bg-blue-400 ml-2",
                                    type="button", data-hab=habitacion.id
                                ) +
                            .flex.gap-4.flex-wrap
                                each cama in habitacion.camas
                                    - var color = 'bg-gray-200 text-gray-800';
                                    - var icono = 'fa-plus';
                                    - var nombrePaciente = cama.paciente || '';
                                    if cama.estado === 'ocupada'
                                        if cama.sexo === 'M'
                                            - color = 'bg-blue-500 text-white'
                                        else if cama.sexo === 'F'
                                            - color = 'bg-pink-500 text-white'
                                        - icono = 'fa-bed'
                                    else if cama.estado === 'libre_sin_higienizar'
                                        - color = 'bg-yellow-400 text-gray-900'
                                    else if cama.estado === 'libre_higienizada'
                                        - color = 'bg-green-400 text-white'

                                    .cama-card(
                                        class=`flex flex-col items-center justify-center w-24 h-24 rounded-xl shadow-xl cursor-pointer relative transition hover:scale-105 ${color}`,
                                        data-id=cama.id,
                                        data-estado=cama.estado,
                                        data-sexo=cama.sexo,
                                        data-hab=habitacion.id,
                                        data-ala=ala.nombre
                                    )
                                        span(class="font-bold text-lg")= cama.id
                                        i(class=`fas ${icono} text-2xl my-1`)
                                        if cama.estado === 'ocupada'
                                            span(class="text-xs font-semibold mt-1") Ocupada por #{nombrePaciente}
                                            button.delete-cama-btn(
                                                class="absolute top-2 right-2 bg-red-500 text-white rounded-full text-xs px-2",
                                                type="button", data-cama=cama.id
                                            ) x
                                        else
                                            button.edit-cama-btn(
                                                class="absolute top-2 right-2 bg-yellow-500 text-white rounded-full text-xs px-2",
                                                type="button", data-cama=cama.id
                                            ) ⚙

    // Popup para asignar cama (oculto por defecto)
    div#popup-cama.fixed.inset-0.flex.items-center.justify-center.z-50.bg-black.bg-opacity-50.hidden
        div.bg-gray-100.p-8.rounded-xl.shadow-2xl.relative.w-96.flex.flex-col.gap-4
            button#close-popup.absolute.top-2.right-2.text-2xl.text-gray-500(type="button") &times;
            h3.text-xl.font-extrabold.mb-4.text-blue-800 Edición de cama
            form#form-cama.flex.flex-col.gap-4
                input(type="hidden" name="cama_id")
                label.text-sm.font-semibold.text-gray-800 Sexo del paciente:
                select(name="sexo" required class="w-full border border-gray-300 p-2 rounded text-gray-900 bg-white")
                    option(value="" disabled selected) Seleccioná…
                    option(value="M") Masculino
                    option(value="F") Femenino
                label.text-sm.font-semibold.text-gray-800 Paciente (solo admitidos):
                select(name="paciente_id" required class="w-full border border-gray-300 p-2 rounded text-gray-900 bg-white")
                    option(value="" disabled selected) Seleccioná paciente…
                div.flex.gap-2.mt-2
                    button(
                        type="submit",
                        class="bg-green-500 hover:bg-green-600 text-white font-bold px-4 py-2 rounded transition"
                        ) Guardar
                        button(
                            id="borrar-cama",
                            type="button",
                            class="bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-2 rounded transition"
                        ) Eliminar cama
    // Overlay modal
    div#popup-overlay.fixed.inset-0.bg-black.bg-opacity-40.z-40.hidden

    // SCRIPTS
    script.
        // Hamburguesa y overlay
        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const closeSidebar = document.getElementById('close-sidebar');
        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
        }
        function closeSidebarFn() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
        }
        menuBtn.addEventListener('click', openSidebar);
        closeSidebar.addEventListener('click', closeSidebarFn);
        sidebarOverlay.addEventListener('click', closeSidebarFn);

        // Pop-up cama
        const popupCama = document.getElementById('popup-cama');
        const popupOverlay = document.getElementById('popup-overlay');
        const closePopup = document.getElementById('close-popup');
        function openPopupCama(camaId, habId, ala) {
            popupCama.classList.remove('hidden');
            popupOverlay.classList.remove('hidden');
            document.querySelector('#form-cama [name="cama_id"]').value = camaId;
            // Acá hacés fetch a tu endpoint para pacientes admitidos según lógica y llenás el select
            fetch(`/api/pacientes-con-turno?ala=${encodeURIComponent(ala)}`)
                .then(r=>r.json())
                .then(pacientes=>{
                    const sel = document.querySelector('#form-cama [name="paciente_id"]');
                    sel.innerHTML = '<option disabled selected>Seleccioná paciente…</option>';
                    pacientes.forEach(p=>{
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.text  = `${p.nombre} (DNI ${p.dni})`;
                        sel.appendChild(opt);
                    });
                });
        }
        function closePopupCama() {
            popupCama.classList.add('hidden');
            popupOverlay.classList.add('hidden');
        }
        closePopup.addEventListener('click', closePopupCama);
        popupOverlay.addEventListener('click', closePopupCama);

        // Abrir popup de edición/agregado
        document.querySelectorAll('.edit-cama-btn, .add-cama-btn').forEach(btn=>{
            btn.addEventListener('click',e=>{
                const camaId = btn.closest('.cama-card')?.dataset.id || null;
                const habId  = btn.closest('.habitacion')?.dataset.id || btn.dataset.hab;
                const ala    = btn.closest('section')?.querySelector('h2')?.textContent || '';
                openPopupCama(camaId, habId, ala);
            });
        });

        // Filtro de sidebar
        document.querySelectorAll('.sidebar-btn').forEach(btn=>{
            btn.addEventListener('click', ()=>{
                const filtro = btn.dataset.filter;
                document.querySelectorAll('.cama-card').forEach(card=>{
                    const estado = card.dataset.estado;
                    if(
                        filtro === 'all' ||
                        (filtro === 'libres' && estado.startsWith('libre')) ||
                        (filtro === 'ocupadas' && estado === 'ocupada') ||
                        (filtro === 'higienizando' && estado === 'libre_sin_higienizar')
                    ){
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
                closeSidebarFn();
            });
        });

        // Guardar/Eliminar cama (acá iría tu AJAX real)
        document.getElementById('form-cama').addEventListener('submit', e=>{
            e.preventDefault();
            alert('Acá va el guardado vía AJAX');
            closePopupCama();
        });
        document.getElementById('borrar-cama').addEventListener('click', ()=>{
            alert('Acá va el borrado vía AJAX');
            closePopupCama();
        });

